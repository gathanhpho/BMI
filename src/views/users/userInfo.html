<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hồ sơ cá nhân</title>
    <link rel="stylesheet" href="style.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</head>

<body>
    <nav class="navbar navbar-expand-lg bg-primary navbar-dark shadow">
        <div class="container">
            <a class="navbar-brand fw-bold" href="user.html">Trang Chủ</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item">
                        <a class="nav-link active" href="userInfo.html">Hồ sơ cá nhân</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="history.html">Lịch sử tra cứu</a>
                    </li>
                </ul>
                <div class="d-flex" id="user-info">
                    <span class="navbar-text text-light me-2" id="user-name">Người dùng</span>
                    <button class="btn btn-danger" id="logout-btn">Đăng xuất</button>
                </div>
            </div>
        </div>
    </nav>

    <div class="container mt-5">
        <div class="card shadow-lg">
            <div class="card-header bg-primary text-white text-center">
                <h3>Hồ sơ cá nhân</h3>
            </div>
            <div class="card-body">
                <form id="profile-form">
                    <div class="mb-3">
                        <label for="username" class="form-label">Tên đăng nhập</label>
                        <input type="text" class="form-control" id="username" disabled>
                    </div>
                    <div class="mb-3">
                        <label for="gmail" class="form-label">Gmail</label>
                        <input type="email" class="form-control" id="gmail" disabled>
                    </div>
                    <div class="mb-3">
                        <label for="created_at" class="form-label">Ngày tạo tài khoản</label>
                        <input type="text" class="form-control" id="created_at" disabled>
                    </div>
                    <button type="button" class="btn btn-warning" id="edit-btn">Chỉnh sửa</button>
                    <button type="submit" class="btn btn-success d-none" id="save-btn">Lưu</button>
                </form>
                <button type="button" class="btn btn-primary mt-3" id="toggle-password-form-btn">Đổi mật khẩu</button>

                <!-- Form đổi mật khẩu (ẩn ban đầu) -->
                <div id="password-form" class="d-none mt-3">
                    <hr>
                    <h4 class="text-center">Đổi mật khẩu</h4>
                    <form id="change-password-form">
                        <div class="mb-3">
                            <label for="current-password" class="form-label">Mật khẩu hiện tại</label>
                            <input type="password" class="form-control" id="current-password">
                        </div>
                        <div class="mb-3">
                            <label for="new-password" class="form-label">Mật khẩu mới</label>
                            <input type="password" class="form-control" id="new-password">
                        </div>
                        <div class="mb-3">
                            <label for="confirm-password" class="form-label">Xác nhận mật khẩu mới</label>
                            <input type="password" class="form-control" id="confirm-password">
                        </div>
                        <button type="button" class="btn btn-success" id="change-password-btn">Lưu mật khẩu</button>
                        <button type="button" class="btn btn-secondary" id="cancel-password-btn">Hủy</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <script>
        function getToken() {
            return localStorage.getItem("token");
        }

        function getUsername() {
            return localStorage.getItem("fullName");
        }

        function clearAuthData() {
            localStorage.removeItem("token");
            localStorage.removeItem("fullName");
        }

        function logout() {
            clearAuthData();
            window.location.href = "/src/views/index.html";
        }

        document.addEventListener("DOMContentLoaded", async function () {
            const token = getToken();
            const fullName = getUsername();
            let idUser = null;
            const userNameSpan = document.getElementById("user-name");

            if (!token || !fullName) {
                alert("Vui lòng đăng nhập để truy cập trang này!");
                window.location.href = "/src/views/index.html";
                return;
            }

            userNameSpan.textContent = `Xin chào, ${fullName}`;

            document.getElementById("logout-btn").addEventListener("click", logout);

            try {
                const response = await fetch("http://localhost:3000/api/v1/user/userInfo", {
                    method: "GET",
                    headers: {
                        "Authorization": `Bearer ${token}`,
                        "Content-Type": "application/json"
                    }
                });
                if (!response.ok) throw new Error("Lỗi khi lấy thông tin người dùng");

                const user = await response.json();
                idUser = user.id_user;
                document.getElementById("username").value = user.full_name;
                document.getElementById("gmail").value = user.gmail;
                document.getElementById("created_at").value = new Date(user.created_at).toLocaleDateString("vi-VN");
                console.log(user.id_user, user.full_name, user.gmail);
            } catch (error) {
                console.error("Lỗi khi tải hồ sơ:", error);
            }

            document.getElementById("edit-btn").addEventListener("click", function () {
                document.getElementById("username").removeAttribute("disabled");
                document.getElementById("gmail").removeAttribute("disabled");
                document.getElementById("edit-btn").classList.add("d-none");
                document.getElementById("save-btn").classList.remove("d-none");
            });

            document.getElementById("profile-form").addEventListener("submit", async function (event) {
                event.preventDefault();
                if (!idUser) {
                    alert("Không tìm thấy ID người dùng!");
                    return;
                }
                const fullName = document.getElementById("username").value;
                const gmail = document.getElementById("gmail").value;

                try {
                    const response = await fetch(`http://localhost:3000/api/v1/user/updateInfo/${idUser}`, {
                        method: "PUT",
                        headers: {
                            "Authorization": `Bearer ${token}`,
                            "Content-Type": "application/json"
                        },
                        body: JSON.stringify({ fullName: fullName, gmail: gmail })
                    });
                    if (!response.ok) throw new Error("Cập nhật thất bại!");
                    alert("Cập nhật thành công!");
                    window.location.reload();
                } catch (error) {
                    console.error(error);
                    alert("Có lỗi xảy ra!");
                }
            });

            // Xử lý hiển thị form đổi mật khẩu
            const passwordForm = document.getElementById("password-form");
            const togglePasswordFormBtn = document.getElementById("toggle-password-form-btn");
            const cancelPasswordBtn = document.getElementById("cancel-password-btn");

            togglePasswordFormBtn.addEventListener("click", function () {
                passwordForm.classList.toggle("d-none");
            });

            cancelPasswordBtn.addEventListener("click", function () {
                passwordForm.classList.add("d-none");
            });

            // Xử lý đổi mật khẩu
            document.getElementById("change-password-btn").addEventListener("click", async function () {
                const currentPassword = document.getElementById("current-password").value;
                const newPassword = document.getElementById("new-password").value;
                const confirmPassword = document.getElementById("confirm-password").value;

                try {
                    const response = await fetch("http://localhost:3000/api/v1/user/changePassword", {
                        method: "POST",
                        headers: {
                            "Authorization": `Bearer ${token}`,
                            "Content-Type": "application/json"
                        },
                        body: JSON.stringify({ currentPassword, newPassword, confirmPassword })
                    });

                    if (!response.ok) {
                        throw new Error("Đổi mật khẩu thất bại!");
                    }

                    alert("Đổi mật khẩu thành công!");
                    passwordForm.classList.add("d-none"); // Ẩn form sau khi đổi mật khẩu thành công
                    document.getElementById("current-password").value = "";
                    document.getElementById("new-password").value = "";
                    document.getElementById("confirm-password").value = "";
                } catch (error) {
                    console.error("Lỗi khi đổi mật khẩu:", error);
                    alert("Có lỗi xảy ra, vui lòng thử lại!");
                }
            });
        });

    </script>
</body>

</html>