<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quản Trị Hệ Thống</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://kit.fontawesome.com/a076d05399.js"></script>
</head>

<body class="d-flex">
    <!-- Sidebar -->
    <nav class="sidebar d-flex flex-column vh-100 bg-dark text-white p-3">
        <h4 class="text-center mb-4">Admin</h4>
        <a href="admin.html" class="text-white text-decoration-none py-2 d-block">
            <i class="fas fa-chart-bar"></i> Thống Kê BMI
        </a>
        <a href="userManager.html" class="text-white text-decoration-none py-2 d-block">
            <i class="fas fa-user"></i> Quản lý người dùng
        </a>
        <a href="bmiManager.html" class="text-white text-decoration-none py-2 d-block">
            <i class="fas fa-user"></i> Quản lý Lịch sử BMI
        </a>
        <button class="btn btn-danger" id="logout-btn">Đăng Xuất</button>
    </nav>

    <!-- Nội dung chính -->
    <div class="main-content flex-grow-1 p-4">
        <div class="container">
            <h2 class="text-primary mb-4">Quản Lý Lịch sử BMI</h2>

            <!-- Thanh tìm kiếm mở rộng -->
            <div class="mb-3 row">
                <label for="from-date" class="col-sm-2 col-form-label">Từ ngày:</label>
                <div class="col-sm-4">
                    <input type="date" id="from-date" class="form-control">
                </div>

                <label for="to-date" class="col-sm-2 col-form-label">Đến ngày:</label>
                <div class="col-sm-4">
                    <input type="date" id="to-date" class="form-control">
                </div>
            </div>

            <div class="mb-3 row">
                <label for="status-select" class="col-sm-2 col-form-label">Trạng thái:</label>
                <div class="col-sm-4">
                    <select id="status-select" class="form-control">
                        <option value="">Tất cả</option>
                        <option value="Thiếu cân">Thiếu cân</option>
                        <option value="Bình thường">Bình thường</option>
                        <option value="Thừa cân">Thừa cân</option>
                        <option value="Béo phì">Béo phì</option>
                    </select>
                </div>
                <div class="col-sm-6 text-end">
                    <button id="search-btn" class="btn btn-primary">Tìm kiếm</button>
                </div>
            </div>

            <!-- Thanh tìm kiếm -->
            <div class="mb-3 row">
                <label for="search-input" class="col-sm-2 col-form-label">Tìm kiếm:</label>
                <div class="col-sm-10">
                    <input type="text" id="search-input" class="form-control" placeholder="Nhập tên...">
                </div>
            </div>

            <div class="container">
                <table class="table table-bordered table-striped">
                    <thead class="table">
                        <tr>
                            <th>STT</th>
                            <th>Họ tên</th>
                            <th>Chiều cao (m)</th>
                            <th>Cân nặng (kg)</th>
                            <th>BMI</th>
                            <th>Trạng thái</th>
                            <th>Ngày tính</th>
                        </tr>
                    </thead>
                    <tbody id="bmi-table-body">
                        <!-- Dữ liệu sẽ được thêm ở đây bằng JavaScript -->
                    </tbody>
                </table>
            </div>

            <div class="d-flex justify-content-center mt-3">
                <ul id="pagination-links" class="pagination"></ul>
            </div>
        </div>
    </div>
    <script>
        function getToken() {
            return localStorage.getItem("token");
        }

        function getUsername() {
            return localStorage.getItem("fullName");
        }

        function clearAuthData() {
            localStorage.removeItem("token");
            localStorage.removeItem("fullName");
        }

        function logout() {
            clearAuthData();
            window.location.href = "/src/views/index.html";
        }

        document.addEventListener("DOMContentLoaded", async function () {
            const token = getToken();
            const fullName = getUsername();

            if (!token || !fullName) {
                alert("Vui lòng đăng nhập để truy cập trang này!");
                window.location.href = "/src/views/index.html";
                return;
            }

            document.getElementById("logout-btn").addEventListener("click", logout);

            let bmiData = [];
            const itemsPerPage = 10;
            let currentPage = 1;

            async function fetchBMIHistory() {
                try {
                    const res = await fetch("http://localhost:3000/api/v1/admin/getAllBMI", {
                        method: "GET",
                        headers: {
                            "Authorization": `Bearer ${token}`,
                            'Content-Type': 'application/json'
                        }
                    });

                    if (!res.ok) throw new Error("Lỗi lấy lịch sử BMI");
                    bmiData = await res.json();
                    if (!Array.isArray(bmiData)) {
                        console.error("Dữ liệu nhận được không phải là mảng:", bmiData);
                        bmiData = []; // Hoặc hiển thị thông báo lỗi phù hợp
                    }
                    renderTable();
                    renderPagination();
                } catch (error) {
                    console.error("Lỗi khi lấy lịch sử BMI:", error);
                }
            }
            async function searchBMIHistory() {
                const keyword = document.getElementById("search-input").value.trim();
                const fromDate = document.getElementById("from-date").value;
                const toDate = document.getElementById("to-date").value;
                const status = document.getElementById("status-select").value;

                // Tạo query string linh hoạt
                const params = new URLSearchParams();
                if (keyword) params.append("keyword", keyword);
                if (fromDate) params.append("fromDate", fromDate);
                if (toDate) params.append("toDate", toDate);
                if (status) params.append("status", status);
                try {

                    const res = await fetch(`http://localhost:3000/api/v1/admin/searchBMI?${params.toString()}`, {
                        method: "GET",
                        headers: {
                            "Authorization": `Bearer ${token}`,
                            'Content-Type': 'application/json'
                        }
                    });

                    if (!res.ok) throw new Error("Lỗi lấy lịch sử BMI");
                    bmiData = await res.json();
                    if (!Array.isArray(bmiData)) {
                        console.error("Dữ liệu nhận được không phải là mảng:", bmiData);
                        bmiData = []; // Hoặc hiển thị thông báo lỗi phù hợp
                    }
                    renderTable();
                    renderPagination();
                } catch (error) {
                    console.error("Lỗi khi tìm kiếm BMI:", error);
                }
            }

            function renderTable() {
                const tableBody = document.getElementById("bmi-table-body");
                tableBody.innerHTML = "";

                const start = (currentPage - 1) * itemsPerPage;
                const end = start + itemsPerPage;
                const paginatedData = bmiData.slice(start, end);

                paginatedData.forEach((item, index) => {
                    const row = `
                        <tr>
                            <td>${start + index + 1}</td>
                            <td>${item.full_name}</td>
                            <td>${item.height}</td>
                            <td>${item.weight}</td>
                            <td>${item.bmi_index}</td>
                            <td>${item.status}</th>
                            <td>${new Date(item.created_at).toLocaleString()}</td>
                            <td><button class="btn btn-danger btn-sm delete-btn" data-id="${item.id_bmi}">Xóa</button></td>
                        </tr>
                    `;
                    tableBody.innerHTML += row;
                });

                if (paginatedData.length === 0) {
                    tableBody.innerHTML = `<tr><td colspan="7" class="text-center">Không có dữ liệu</td></tr>`;
                }

                // Lắng nghe sự kiện click trên các nút xóa
                const deleteButtons = document.querySelectorAll('.delete-btn');
                deleteButtons.forEach(button => {
                    button.addEventListener('click', function () {
                        const idBMI = button.getAttribute('data-id');
                        deleteBMI(idBMI);
                    });
                });
            }

            function renderPagination() {
                const totalPages = Math.ceil(bmiData.length / itemsPerPage);
                const paginationContainer = document.getElementById("pagination-links");
                paginationContainer.innerHTML = "";

                for (let i = 1; i <= totalPages; i++) {
                    const pageItem = document.createElement("li");
                    pageItem.classList.add("page-item");
                    if (i === currentPage) pageItem.classList.add("active");

                    const pageLink = document.createElement("a");
                    pageLink.classList.add("page-link");
                    pageLink.href = "#";
                    pageLink.textContent = i;

                    pageLink.addEventListener("click", function (e) {
                        e.preventDefault();
                        currentPage = i;
                        renderTable();
                        renderPagination();
                    });

                    pageItem.appendChild(pageLink);
                    paginationContainer.appendChild(pageItem);
                }
            }



            document.getElementById("search-btn").addEventListener("click", () => {
                const keyword = document.getElementById("search-input").value.trim();
                const fromDate = document.getElementById("from-date").value;
                const toDate = document.getElementById("to-date").value;
                const status = document.getElementById("status-select").value;

                searchBMIHistory(keyword, fromDate, toDate, status);
            });

            // Xoá dữ liệu BMI
            async function deleteBMI(idBMI) {
                const token = getToken();
                if (confirm('Bạn có chắc chắn muốn xóa dữ liệu này?')) {
                    try {
                        const response = await fetch(`http://localhost:3000/api/v1/admin/delete/${idBMI}`, {
                            method: 'DELETE',
                            headers: {
                                'Authorization': `Bearer ${token}`,
                                'Content-Type': 'application/json'
                            }
                        });

                        if (!response.ok) {
                            throw new Error('Không thể xóa dữ liệu');
                        }

                        alert('Dữ liệu đã được xóa thành công');
                        // Tải lại trang sau khi xóa dữ liệu
                        window.location.reload();
                    } catch (error) {
                        console.error("Lỗi khi lấy dữ liệu", error);
                    }
                }
            }
            // Gọi API khi trang load
            fetchBMIHistory();
        });
    </script>

</body>