<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Qu·∫£n Tr·ªã H·ªá Th·ªëng</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://kit.fontawesome.com/a076d05399.js"></script>
</head>

<body class="d-flex">
    <!-- Sidebar -->
    <nav class="sidebar d-flex flex-column vh-100 bg-dark text-white p-3">
        <h4 class="text-center mb-4">Admin</h4>
        <a href="admin.html" class="text-white text-decoration-none py-2 d-block">
            <i class="fas fa-chart-bar"></i> Th·ªëng K√™ BMI
        </a>
        <a href="userManager.html" class="text-white text-decoration-none py-2 d-block">
            <i class="fas fa-user"></i> Qu·∫£n l√Ω ng∆∞·ªùi d√πng
        </a>
        <a href="bmiManager.html" class="text-white text-decoration-none py-2 d-block">
            <i class="fas fa-user"></i> Qu·∫£n l√Ω LiÃ£ch s∆∞Ãâ BMI
        </a>
        <button class="btn btn-danger" id="logout-btn">ƒêƒÉng Xu·∫•t</button>
    </nav>

    <!-- N·ªôi dung ch√≠nh -->
    <div class="main-content flex-grow-1 p-4">
        <div class="container">
            <h2 class="text-primary mb-4">Th·ªëng K√™ Ch·ªâ S·ªë BMI</h2>
            <p>Ch√†o m·ª´ng <span id="user-name"></span> ƒë·∫øn v·ªõi h·ªá th·ªëng qu·∫£n tr·ªã.</p>

            <!-- T·ªïng s·ªë user v√† l·ªãch s·ª≠ BMI -->
            <div class="row mb-4">
                <div class="col-md-6">
                    <div class="card shadow p-3 text-center">
                        <h5>T·ªïng s·ªë t√†i kho·∫£n</h5>
                        <p id="total-users" class="display-5 text-primary">0</p>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="card shadow p-3 text-center">
                        <h5>T·ªïng s·ªë l·ªãch s·ª≠ BMI</h5>
                        <p id="total-bmi-history" class="display-5 text-danger">0</p>
                    </div>
                </div>
            </div>

            <!-- Bi·ªÉu ƒë·ªì -->
            <div class="row">
                <div class="col-md-6">
                    <div class="card shadow p-3">
                        <h5 class="text-center">Ph√¢n lo·∫°i BMI</h5>
                        <canvas id="bmiPieChart" style="max-width: 250px; max-height: 250px; margin: auto;"></canvas>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="card shadow p-3">
                        <h5 class="text-center">Xu h∆∞·ªõng BMI theo th√°ng</h5>
                        <canvas id="bmiLineChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // L∆∞u token v√† th√¥ng tin ng∆∞·ªùi d√πng v√†o localStorage
        function saveAuthData(token, fullName) {
            localStorage.setItem("token", token);
            localStorage.setItem("fullName", fullName);
        }

        function getToken() {
            return localStorage.getItem("token");
        }

        function getUsername() {
            return localStorage.getItem("fullName");
        }

        function clearAuthData() {
            localStorage.removeItem("token");
            localStorage.removeItem("fullName");
        }

        function logout() {
            clearAuthData();
            window.location.href = "/src/views/index.html";
        }

        document.addEventListener("DOMContentLoaded", async function () {
            const token = getToken();
            const fullName = getUsername();
            const userNameSpan = document.getElementById("user-name");

            if (!token || !fullName) {
                alert("Vui l√≤ng ƒëƒÉng nh·∫≠p ƒë·ªÉ truy c·∫≠p trang n√†y!");
                window.location.href = "/src/views/index.html";
                return;
            }

            userNameSpan.textContent = `Xin ch√†o, ${fullName}`;
            document.getElementById("logout-btn").addEventListener("click", logout);

            // L·∫•y d·ªØ li·ªáu th·ªëng k√™ t√¥Ãâng s·ªë user
            try {
                const userRes = await fetch("http://localhost:3000/api/v1/admin/total-users", {
                    method: "GET",
                    headers: {
                        "Authorization": `Bearer ${token}`,
                        "Content-Type": "application/json"
                    }
                });
                const totalUsers = await userRes.json();
                document.getElementById("total-users").textContent = totalUsers.toLocaleString();
            } catch (error) {
                console.error("L·ªói l·∫•y t·ªïng s·ªë t√†i kho·∫£n:", error);
            }

            // L·∫•y d·ªØ li·ªáu th·ªëng k√™ t√¥Ãâng s·ªë BMI
            try {
                const bmiRes = await fetch("http://localhost:3000/api/v1/admin/total-bmi-history", {
                    method: "GET",
                    headers: {
                        "Authorization": `Bearer ${token}`,
                        "Content-Type": "application/json"
                    }
                });
                const totalBMIHistory = await bmiRes.json();
                console.log(totalBMIHistory);
                document.getElementById("total-bmi-history").textContent = totalBMIHistory.toLocaleString();
            } catch (error) {
                console.error("L·ªói l·∫•y t·ªïng s·ªë l·ªãch s·ª≠ BMI:", error);
            }

            // üü¢ Bi·ªÉu ƒë·ªì tr√≤n - Ph√¢n lo·∫°i BMI
            try {
                const response = await fetch("http://localhost:3000/api/v1/admin/status-by-status", {
                    method: "GET",
                    headers: {
                        "Authorization": `Bearer ${token}`,
                        "Content-Type": "application/json"
                    }
                });

                const data = await response.json();
                // console.log(data);
                if (!data) throw new Error("Kh√¥ng c√≥ d·ªØ li·ªáu!");

                const ctxPie = document.getElementById("bmiPieChart").getContext("2d");
                new Chart(ctxPie, {
                    type: "pie",
                    data: {
                        labels: data.labels,
                        datasets: [{
                            data: data.values,
                            backgroundColor: ["#007bff", "#28a745", "#ffc107", "#dc3545"]
                        }]
                    },
                    options: { responsive: true }
                });

            } catch (error) {
                console.error("L·ªói khi l·∫•y d·ªØ li·ªáu BMI:", error);
            };


            // Bi·ªÉu ƒë√¥ÃÄ ƒë∆∞∆°ÃÄng - Xu h∆∞·ªõng BMI theo th√°ng
            try {
                const response = await fetch("http://localhost:3000/api/v1/admin/status-by-month", {
                    method: "GET",
                    headers: {
                        "Authorization": `Bearer ${token}`,
                        "Content-Type": "application/json"
                    }
                });

                const { labels, underweight, normal, overweight, obese } = await response.json();
                if (!labels || labels.length === 0) throw new Error("Kh√¥ng c√≥ d·ªØ li·ªáu!");

                // console.log("‚úÖ D·ªØ li·ªáu BMI theo th√°ng:", labels, underweight, normal, overweight, obese);

                // üîµ V·∫Ω bi·ªÉu ƒë·ªì ƒë∆∞·ªùng
                const ctxLine = document.getElementById("bmiLineChart").getContext("2d");
                new Chart(ctxLine, {
                    type: "line",
                    data: {
                        labels,
                        datasets: [
                            { label: "Thi·∫øu c√¢n", data: underweight, borderColor: "#007bff", fill: false },
                            { label: "B√¨nh th∆∞·ªùng", data: normal, borderColor: "#28a745", fill: false },
                            { label: "Th·ª´a c√¢n", data: overweight, borderColor: "#ffc107", fill: false },
                            { label: "B√©o ph√¨", data: obese, borderColor: "#dc3545", fill: false }
                        ]
                    },
                    options: { responsive: true }
                });

            } catch (error) {
                console.error("L·ªói khi l·∫•y d·ªØ li·ªáu BMI theo th√°ng:", error);
            }
        });
    </script>

</body>

</html>